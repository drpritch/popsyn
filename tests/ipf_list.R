#
# Unit tests for ipf_list.R
#

library('gtools')

source('ipf.R')
source('ipf_list.R')

# Buried inside a function to hide scope.
(function() {

# A fairly fake test: build tabs from 100% of the PUM, then throw away 90%
# of the PUM and use that as a starting point for the fitting.
testpop <- pum86$i[, c('hlosp', 'sexp', 'agep', 'occ81p')]
testtab <- xtabs(~hlosp + sexp + agep + occ81p, testpop)
testpop <- testpop[seq(nrow(testpop)/2),]

print('Test: Four 3-way constraints, no prior association')
result <- ipf_list(constraintList =
        lapply(list(margin.table(testtab, c(1,2,3)),
                    margin.table(testtab, c(1,2,4)),
                    margin.table(testtab, c(1,3,4)),
                    margin.table(testtab, c(2,3,4))),
               IpfConstraint),
        popFrame = testpop,
        priorAssoc = 'none',
    maxIterations = 100,
    # High tolerance... just to make comparison easier.
    tolerance = 1/1000)
# Tabulate
result_t <- xtabs(weight ~ hlosp + sexp + agep + occ81p, result)
eresult <- array(
    data = c(
      0.0000,    4.0000,    0.0000,    0.0000,    0.0000,    0.0000,    0.0000,
      0.0000,    0.0000,    0.0000,    0.0000,    0.0000,    0.0000,    4.4650,
      0.0000,    3.5350,    0.0000,    0.0000,    0.0000,    3.7733,    8.2267,
      0.0000,    0.0000,    0.0000,    0.0000,   15.0635,   18.9278,   50.9056,
     21.1560,   43.9470,    0.0000,   18.0466,   17.1949,   44.4191,   23.9947,
     42.3447,    0.0000,   62.3657,   90.2037,  168.6377,  102.1253,  247.6677,
      4.9978,   75.6374,   80.8134,  201.3721,  128.8776,  397.3017,    9.4714,
     57.0282,   80.1550,  137.7474,   96.6495,  130.9485,   18.5294,  100.9794,
     99.8685,  267.2639,  199.3548,  445.0042,   12.0771,   53.3081,   51.7150,
     96.4722,   46.4048,   40.0229,   31.9223,  101.7006,   83.2978,  210.5359,
    121.5933,  193.9501,   10.2557,   33.6058,   21.9178,   39.1986,   20.4513,
     21.5708,   29.7450,   82.4002,   45.0882,  112.8043,   68.5479,  130.4143,
      2.9529,    4.0895,    3.4027,    4.7864,    2.7685,    0.0000,   10.0476,
     15.9110,    9.5982,   19.2141,   11.2317,   22.9973,    0.0000,   19.8540,
      2.1460,    0.0000,    0.0000,    0.0000,    0.0000,   22.0000,    0.0000,
      0.0000,    0.0000,    0.0000,    0.0000,    9.5720,   13.0997,    7.3233,
      8.0049,    0.0000,    0.0000,   12.4248,   16.8960,    2.6792,    0.0000,
      0.0000,    0.0000,   17.2466,   21.6134,  187.7201,   97.8077,   99.6122,
      0.0000,   17.7535,   23.3868,   89.2793,   70.1925,   63.3878,    0.0000,
     30.0251,   36.1327,  330.4571,  155.3243,  571.0607,    2.0000,   33.9749,
     41.8674,  233.5420,  134.6755,  656.9402,   14.3662,   31.7591,   37.0239,
    266.8824,  148.6341,  442.3342,    4.6334,   27.2408,   30.9759,  159.1140,
    109.3647,  559.6712,   11.6313,   41.1909,   19.1491,  167.3019,   69.7819,
    165.9450,    4.3684,   32.8089,   17.8509,   96.6961,   56.2177,  258.0579,
      8.9991,   23.7604,   10.9439,   74.6356,   37.4108,   67.2502,    4.0007,
     26.2395,   14.0561,   61.3637,   41.5891,  140.7508,    0.0000,    0.0000,
      0.9617,    9.6623,    3.4358,   11.9401,    8.0009,    4.0005,    2.0382,
     13.3363,    5.5638,   35.0603,   13.7089,  380.1641,   46.1263,    0.0007,
      0.0000,    0.0000,   13.3259,  309.6928,   30.9657,    9.0156,    0.0000,
      0.0000,    2.1297,  185.5340,  249.1889,  100.4291,   59.7183,    0.0000,
      5.8685,  149.4522,  137.8178,   32.5828,   44.2788,    0.0000,   17.3601,
    313.6338,  386.4085,  659.8872,  358.1158,  162.5947,   10.6403,  207.3807,
    185.5765,  288.0735,  276.9196,  100.4095,   62.4155,  542.4798,  585.5187,
    926.8808,  350.5886,  331.1166,   33.5833,  313.5201,  239.4358,  478.0926,
    260.4378,  293.9304,  142.4034,  510.6912,  394.6702,  631.4820,  240.8629,
    163.8903,   88.6031,  246.2959,  128.2884,  302.5010,  167.1569,  176.1548,
    199.4879,  420.4486,  242.6043,  416.7237,  103.0927,   50.6428,  158.5325,
    206.5333,   96.3743,  212.2619,   85.9198,   73.3783,  175.4710,  322.0051,
    137.5768,  230.5623,   59.7939,   31.5910,  156.5396,  207.9806,   71.4097,
    158.4315,   65.2148,   58.4238,   34.9625,   49.6583,   32.4871,   35.9472,
     17.9547,    5.9902,   34.0378,   47.3417,   21.5078,   32.0516,   22.0479,
     12.0132,    0.0000,   10.9004,    0.8282,    5.2714,    0.0000,    0.0000,
      0.0000,   54.4991,    5.5009,    0.0000,    0.0000,    0.0000,    1.4011,
     22.9235,   11.3188,    4.3567,    0.0000,    0.0000,    8.5986,   89.0799,
     48.6820,   23.6427,   16.9968,    0.0000,   13.8679,   62.7687,   31.6471,
     27.1402,   12.8351,    5.7410,   31.1292,  329.2271,  194.3521,  325.8667,
    118.1665,   23.2583,   83.7324,  165.0087,   65.5390,   73.0336,   27.6576,
     18.0287,  116.2511,  532.9793,  241.4582,  729.9943,  172.3460,   73.9711,
    164.8611,  139.7991,   44.9944,   60.0204,   17.8494,   13.4756,  255.1116,
    363.1918,  127.0036,  537.0121,  100.1545,   64.5263,  189.2790,   92.5044,
     16.9733,   39.1450,    5.6948,    4.4035,  402.6987,  263.4906,   63.0271,
    400.8786,   41.3072,   30.5978,  105.8394,   41.8210,    7.7666,   14.5962,
      1.9769,    0.0000,  310.1463,  192.1783,   46.2341,  247.4164,   23.0241,
     12.0009,    9.8208,    0.0000,    0.0000,    1.1792,    0.0000,    0.0000,
     20.8882,   22.5264,   10.2393,   17.2504,    4.0957,    0.0000,    0.0000,
     19.2364,    1.7636,    0.0000,    0.0000,    0.0000,    0.0000,   68.7636,
      7.2364,    0.0000,    0.0000,    0.0000,    0.0000,    0.0000,   13.1782,
      4.1355,    3.6863,    0.0000,    0.0000,   79.5286,   29.1257,    6.9453,
      8.4004,    0.0000,    7.0217,   33.6181,   24.1694,   17.3538,   19.2497,
     11.5874,    7.9796,  108.3819,   78.8305,   66.6452,   77.7488,   21.4141,
     23.6895,   73.4219,   28.9984,   40.2348,   16.9146,   22.7409,   17.3148,
    151.5793,   59.0022,  133.7597,   48.0841,   44.2598,   52.0437,   50.0266,
     17.0076,   23.1299,   10.2673,    9.5249,   47.9622,   93.9733,   29.9926,
     77.8660,   29.7315,   24.4744,   60.7927,   27.2875,    7.4154,   13.9459,
      1.3878,    5.1708,   83.2124,   60.7123,   18.5843,   58.0509,    5.6120,
     20.8281,   45.0564,   20.5756,    3.5952,    9.2523,    1.5206,    0.0000,
     72.9485,   63.4241,   12.4047,   54.7453,    8.4790,   17.9984,    0.0000,
      7.0000,    0.0000,    0.0000,    0.0000,    0.0000,   19.9957,    3.0079,
      1.9996,    4.9989,    2.9994,    6.9985,   46.5123,  851.5545,   40.9208,
     16.0125,    0.0000,    0.0000,   56.5971,  872.2360,   43.1668,    0.0000,
      0.0000,    0.0000,   10.0063,  146.3696,   94.1793,   20.6846,   16.7602,
      0.0000,    0.0000,  182.6190,  100.8229,   15.3198,   21.2383,    0.0000,
     30.2668,  150.4700,   69.1501,  105.0816,  108.2878,   55.7437,   17.7330,
     95.5297,   39.8495,   64.9181,   88.7135,   34.2561,  131.2309,  356.2433,
    231.3822,  277.6391,  114.8489,  155.6555,   21.7686,   63.7559,   36.6168,
     65.3616,   29.1515,   44.3455,  222.0045,  290.2983,  138.9889,  271.6204,
    110.0944,  113.9935,   38.9953,   39.7002,   16.0101,   54.3802,   23.9060,
     36.0082,  385.9862,  290.9373,  120.0429,  175.3383,   54.8125,   48.8828,
     92.0145,   43.0613,   17.9565,   39.6619,   15.1877,   22.1181,  647.6398,
    526.9231,  178.1233,  258.7040,   81.9769,   68.6329,  233.3606,  138.0734,
     46.8755,  106.2972,   40.0240,   53.3693, 1349.7936,  930.2045,  363.1758,
    472.5400,  150.9632,  110.3229,  774.1889,  524.7810,  177.8113,  367.4797,
    121.0440,  135.6950),
dim = c(6,2,8,6),
    dimnames = list(
        hlosp = c("Less than grade 9", "Grades 9-13", "High school",
                  "Trades and non-uni", "University w/o degree", "University"),
        sexp = c("Female", "Male"),
        agep = c("15-17", "18-19", "20-24", "25-34", "35-44", "45-54", "55-64", "65+"),
        occ81p = c("Manage/admin", "Sci/teach/art", "Clerical/sales/service",
                   "Proc/Mach fab/Construct/Transp", "Other/Relig/Farm/Primary",
                   "NA"))
)
assert(eresult == round(result_t, 4))

# Compare with normal array-based IPF. Should be essentially the same result,
# subject to differences in stopping tolerances etc.
result_i <- ipf(constraintList =
        lapply(list(margin.table(testtab, c(1,2,3)),
                    margin.table(testtab, c(1,2,4)),
                    margin.table(testtab, c(1,3,4)),
                    margin.table(testtab, c(2,3,4))),
               IpfConstraint),
        # Use same sparsity pattern, with all ones as prior - i.e., same
        # input as ipf_list.
        priorArray = (xtabs(~hlosp + sexp + agep + occ81p, testpop) > 0) * 1,
    maxIterations = 100,
    tolerance = 1/100)
# Note that with higher tolerances on both, we get tighter agreement.
assert(abs(result_t - result_i) < 0.02)



print('Test: Four 3-way constraints, prior association from population')
result <- ipf_list(constraintList =
        lapply(list(margin.table(testtab, c(1,2,3)),
                    margin.table(testtab, c(1,2,4)),
                    margin.table(testtab, c(1,3,4)),
                    margin.table(testtab, c(2,3,4))),
               IpfConstraint),
        popFrame = testpop,
        priorAssoc = 'frompop',
    maxIterations = 100,
    tolerance = 1/1000)
# Tabulate
result_t <- xtabs(weight ~ hlosp + sexp + agep + occ81p, result)
eresult <- array(
    data = c(
      0.0000,    4.0000,    0.0000,    0.0000,    0.0000,    0.0000,    0.0000,
      0.0000,    0.0000,    0.0000,    0.0000,    0.0000,    0.0000,    4.4672,
      0.0000,    3.5328,    0.0000,    0.0000,    0.0000,    3.7700,    8.2300,
      0.0000,    0.0000,    0.0000,    0.0000,   14.9902,   20.2618,   42.0338,
     16.1484,   56.5657,    0.0000,   18.1199,   15.8622,   53.2819,   28.9974,
     29.7386,    0.0000,   71.9505,   87.6971,  174.3838,  108.9500,  228.0186,
      4.9978,   66.0623,   83.3172,  195.6317,  122.0598,  416.9312,    3.1514,
     64.7740,   83.9025,  124.6064,   96.3194,  139.2463,   24.8432,   93.2412,
     96.1247,  280.3921,  199.6845,  436.7144,   16.3316,   46.6005,   51.2970,
    102.7898,   47.3593,   35.6218,   27.6721,  108.4016,   83.7155,  204.2248,
    120.6397,  198.3464,   12.1124,   23.4383,   21.4843,   46.3309,   18.9249,
     24.7091,   27.8901,   92.5575,   45.5211,  105.6791,   70.0728,  127.2794,
      3.1618,    3.7011,    1.6805,    7.6046,    1.8521,    0.0000,    9.8389,
     16.2992,   11.3192,   16.3977,   12.1476,   22.9975,    0.0000,   19.8541,
      2.1459,    0.0000,    0.0000,    0.0000,    0.0000,   22.0000,    0.0000,
      0.0000,    0.0000,    0.0000,    0.0000,    7.6318,   16.8427,    5.5206,
      8.0048,    0.0000,    0.0000,   14.3625,   13.1580,    4.4795,    0.0000,
      0.0000,    0.0000,   17.2225,   20.2230,  192.7810,   98.0955,   95.6779,
      0.0000,   17.7777,   24.7775,   84.2176,   69.9048,   67.3224,    0.0000,
     22.2719,   31.8954,  331.8620,  143.9731,  592.9977,    2.0000,   41.7286,
     46.1050,  232.1357,  146.0270,  635.0036,   14.0550,   38.7866,   36.7784,
    250.4311,  170.1395,  430.8093,    4.9446,   20.2127,   31.2214,  175.5663,
     87.8574,  571.1976,   11.6768,   43.0495,   21.0316,  170.5265,   63.0079,
    165.7077,    4.3230,   30.9502,   15.9683,   93.4717,   62.9921,  258.2947,
      9.2659,   24.5840,   10.3800,   80.5845,   32.8095,   65.3763,    3.7339,
     25.4159,   14.6201,   55.4141,   46.1906,  142.6254,    0.0000,    0.0000,
      1.7828,   12.2651,    4.3644,    7.5876,    8.0009,    4.0004,    1.2168,
     10.7325,    4.6348,   39.4146,   11.2665,  381.5883,   47.1425,    0.0026,
      0.0000,    0.0000,   15.7711,  308.2668,   29.9481,    9.0140,    0.0000,
      0.0000,    0.9870,  164.3087,  266.4299,  101.7276,   63.5467,    0.0000,
      7.0106,  170.6648,  120.5872,   31.2846,   40.4528,    0.0000,   17.4598,
    312.7920,  378.3644,  651.6183,  377.6756,  160.0899,   10.5405,  208.2235,
    193.6262,  296.3476,  257.3459,  102.9162,   55.8651,  560.9041,  592.0593,
    924.8342,  345.4031,  319.9342,   40.1385,  295.0822,  232.8897,  480.1403,
    265.6276,  305.1218,  158.2497,  496.9913,  389.5993,  652.4964,  227.9475,
    158.7158,   72.7444,  260.0064,  133.3631,  281.4702,  180.0824,  181.3335,
    191.1149,  443.7241,  228.4223,  406.1136,   99.4974,   64.1277,  166.9117,
    183.2403,  110.5671,  222.8801,   89.5177,   59.8831,  179.3190,  324.2760,
    143.0263,  225.1156,   50.8974,   34.3657,  152.6888,  205.7079,   65.9559,
    163.8822,   74.1180,   55.6472,   33.7852,   39.9548,   29.5701,   39.9981,
     25.1179,    8.5738,   35.2164,   57.0559,   24.4278,   27.9961,   14.8769,
      9.4269,    0.0000,    9.6577,    2.0712,    5.2710,    0.0000,    0.0000,
      0.0000,   55.7430,    4.2570,    0.0000,    0.0000,    0.0000,    2.5392,
     31.2782,    3.4601,    2.7225,    0.0000,    0.0000,    7.4616,   80.7336,
     56.5326,   25.2753,   16.9969,    0.0000,   17.1608,   56.7524,   29.4131,
     28.4253,   14.1526,    8.0958,   27.8355,  335.2459,  196.5869,  324.5806,
    116.8483,   20.9028,   94.2282,  168.4075,   60.1155,   52.2853,   31.2059,
     26.7576,  105.7543,  529.5810,  246.8837,  750.7454,  168.7961,   65.2395,
    146.4919,  151.8924,   51.2370,   74.2278,   12.0922,    5.0587,  273.4904,
    351.0950,  120.7589,  522.7961,  105.9135,   72.9461,  201.1023,   79.2479,
     19.5470,   41.6262,    4.7373,    1.7394,  390.8749,  276.7524,   60.4525,
    398.3929,   42.2647,   33.2627,   99.6789,   38.5265,   13.2050,   16.7607,
      3.8289,    0.0000,  316.3129,  195.4740,   40.7939,  245.2474,   21.1713,
     12.0006,    7.5710,    0.0000,    0.0000,    3.4290,    0.0000,    0.0000,
     23.1413,   22.5253,   10.2388,   14.9990,    4.0955,    0.0000,    0.0000,
     16.9294,    4.0706,    0.0000,    0.0000,    0.0000,    0.0000,   71.0707,
      4.9293,    0.0000,    0.0000,    0.0000,    0.0000,    0.0000,   12.9183,
      5.3692,    2.7125,    0.0000,    0.0000,   79.5292,   29.3848,    5.7135,
      9.3725,    0.0000,    2.5621,   29.5486,   32.4064,   26.2903,   14.1610,
      8.0316,   12.4376,  112.4501,   70.5959,   57.7116,   82.8363,   24.9685,
     27.5683,   63.3680,   20.2485,   48.3497,   22.3199,   24.1455,   13.4364,
    161.6298,   67.7492,  125.6483,   42.6807,   42.8555,   64.2840,   52.9420,
     13.1346,   12.1212,    8.1766,   11.3417,   35.7239,   91.0588,   33.8646,
     88.8727,   31.8219,   22.6582,   58.5620,   31.2365,    8.3770,    8.8714,
      3.4519,    5.5012,   85.4417,   56.7644,   17.6230,   63.1244,    3.5484,
     20.4980,   35.6561,   30.1197,    4.9623,    7.0511,    2.2109,    0.0000,
     82.3457,   53.8831,   11.0380,   56.9457,    7.7890,   17.9985,    0.0000,
      7.0000,    0.0000,    0.0000,    0.0000,    0.0000,   19.9978,    3.0041,
      1.9998,    4.9995,    2.9997,    6.9992,   48.9610,  853.6713,   36.3542,
     16.0134,    0.0000,    0.0000,   54.1468,  870.1180,   47.7352,    0.0000,
      0.0000,    0.0000,   10.0069,  161.1833,   81.3137,   21.5913,   13.9047,
      0.0000,    0.0000,  167.8237,  113.6717,   14.4147,   24.0899,    0.0000,
     31.3313,  161.5064,   71.2531,  106.9323,   97.2065,   50.7704,   16.6685,
     84.4924,   37.7464,   63.0673,   99.7955,   39.2299,  123.3990,  342.6767,
    245.7570,  285.1613,  115.6100,  154.3961,   29.6013,   77.3238,   22.2409,
     57.8386,   28.3904,   45.6049,  218.8848,  274.2576,  138.1949,  276.9772,
    109.6875,  128.9979,   42.1155,   55.7431,   16.8040,   49.0226,   24.3130,
     21.0017,  380.4357,  281.8348,  129.2339,  179.0054,   63.1240,   42.3661,
     97.5664,   52.1641,    8.7636,   35.9943,    6.8751,   28.6365,  657.2345,
    527.7446,  166.8598,  251.1093,   94.4588,   64.5930,  223.7649,  137.2510,
     58.1402,  113.8931,   27.5407,   57.4102, 1353.0801,  940.2410,  366.9799,
    460.8243,  143.7818,  112.0929,  770.9001,  514.7394,  174.0049,  379.2015,
    128.2291,  133.9250),
dim = c(6,2,8,6),
    dimnames = list(
        hlosp = c("Less than grade 9", "Grades 9-13", "High school",
                  "Trades and non-uni", "University w/o degree", "University"),
        sexp = c("Female", "Male"),
        agep = c("15-17", "18-19", "20-24", "25-34", "35-44", "45-54", "55-64", "65+"),
        occ81p = c("Manage/admin", "Sci/teach/art", "Clerical/sales/service",
                   "Proc/Mach fab/Construct/Transp", "Other/Relig/Farm/Primary",
                   "NA"))
)
assert(eresult == round(result_t, 4))

result_i <- ipf(constraintList =
        lapply(list(margin.table(testtab, c(1,2,3)),
                    margin.table(testtab, c(1,2,4)),
                    margin.table(testtab, c(1,3,4)),
                    margin.table(testtab, c(2,3,4))),
               IpfConstraint),
        priorArray = xtabs(~hlosp + sexp + agep + occ81p, testpop),
    maxIterations = 100,
    tolerance = 1/100)
# Note that with higher tolerances on both, we get tighter agreement.
assert(abs(result_t - result_i) < 0.02)

})()
