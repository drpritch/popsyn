#
# Unit tests for ipf.R
#

library('gtools')

source('ipf.R')

# Buried inside a function to hide scope.
(function() {

testtab <- array(
    data = c(
        0, 5, 4, 1, 1, 1, 0, 8, 4, 3, 1, 0, 0, 16, 18,
        46, 20, 50, 1, 17, 18, 49, 25, 36, 0, 68, 90, 176, 101, 236,
        5, 70, 81, 194, 130, 409, 9, 57, 79, 136, 95, 136, 19, 101, 101,
        269, 201, 440, 12, 53, 53, 97, 48, 37, 32, 102, 82, 210, 120, 197,
        11, 31, 21, 39, 22, 23, 29, 85, 46, 113, 67, 129, 3, 4, 1,
        6, 3, 1, 10, 16, 12, 18, 11, 22, 0, 30, 16, 8, 6, 0,
        0, 31, 16, 2, 3, 2, 0, 15, 24, 194, 94, 97, 0, 20, 21,
        83, 74, 66, 0, 30, 30, 316, 146, 601, 2, 34, 48, 248, 144, 627,
        12, 36, 33, 261, 162, 437, 7, 23, 35, 165, 96, 565, 11, 36, 23,
        171, 73, 161, 5, 38, 14, 93, 53, 263, 9, 24, 14, 82, 38, 56,
        4, 26, 11, 54, 41, 152, 3, 1, 1, 12, 2, 7, 5, 3, 2,
        11, 7, 40, 16, 548, 307, 102, 64, 0, 19, 476, 157, 40, 41, 0,
        18, 310, 372, 652, 376, 170, 10, 211, 200, 296, 259, 93, 57, 548, 591,
        935, 356, 312, 39, 308, 234, 470, 255, 313, 147, 517, 397, 635, 229,159,
        84, 240, 126, 299, 179, 181, 198, 431, 234, 413, 97, 60, 160, 196, 105,
        216, 92, 64, 180, 322, 141, 228, 48, 38, 152, 208, 68, 161, 77, 52,
        32, 49, 33, 35, 21, 7, 37, 48, 21, 33, 19, 11, 3, 31, 10,
        11, 2, 0, 11, 143, 56, 22, 15, 0, 12, 60, 35, 31, 10, 6,
        33, 332, 191, 322, 121, 23, 93, 169, 63, 53, 32, 23, 107, 529, 244,
        750, 168, 69, 157, 141, 47, 71, 16, 9, 263, 362, 125, 526, 102, 69,
        198, 87, 14, 42, 3, 4, 394, 269, 66, 398, 44, 31, 101, 45, 9,
        14, 3, 0, 315, 189, 45, 248, 22, 12, 6, 2, 1, 2, 0, 0,
        24, 20, 9, 16, 4, 2, 1, 26, 12, 1, 2, 0, 0, 141, 39,
        10, 10, 0, 5, 31, 29, 20, 17, 11, 10, 111, 74, 64, 80, 22,
        25, 64, 24, 51, 20, 22, 16, 161, 64, 123, 45, 45, 65, 51, 16,
        16, 8, 6, 35, 93, 31, 85, 32, 28, 56, 31, 11, 9, 3, 6,
        88, 57, 15, 63, 4, 20, 33, 26, 4, 11, 3, 3, 85, 58, 12,
        53, 7, 15, 4, 2, 0, 0, 0, 1, 16, 8, 2, 5, 3, 6,
        56, 1011, 123, 35, 18, 0, 57, 1040, 156, 17, 22, 0, 34, 161, 74,
        105, 100, 45, 14, 85, 35, 65, 97, 45, 126, 351, 240, 286, 112, 152,
        27, 69, 28, 57, 32, 48, 215, 278, 141, 272, 114, 127, 46, 52, 14,
        54, 20, 23, 384, 288, 123, 177, 57, 47, 94, 46, 15, 38, 13, 24,
        659, 521, 171, 253, 89, 69, 222, 144, 54, 112, 33, 53, 1349, 933, 364,
        469, 149, 113, 775, 522, 177, 371, 123, 133),
    dim = c(6,2,7,6),
    dimnames = list(
        hlosp = c("Less than grade 9", "Grades 9-13", "High school",
                  "Trades and non-uni", "University w/o degree", "University"),
        sexp = c("Female", "Male"),
        agep = c("15-19", "20-24", "25-34", "35-44", "45-54", "55-64", "65+"),
        occ81p = c("Manage/admin", "Sci/teach/art", "Clerical/sales/service",
                   "Proc/Mach fab/Construct/Transp", "Other/Relig/Farm/Primary",
                   "NA"))
)



#
# Simple test: ensure that three-way tests work okay.
#

cat('Test: Four 3-way constraints\n')
result <- ipf(constraintList =
        lapply(list(margin.table(testtab, c(1,2,3)),
                    margin.table(testtab, c(1,2,4)),
                    margin.table(testtab, c(1,3,4)),
                    margin.table(testtab, c(2,3,4))),
               IpfConstraint),
    dimnameList = dimnames(testtab),
    maxIterations = 20,
    tolerance = 1/100)
eresult <- array(
    data = c(
    0, 4.9617, 3.5217, 2.3583, 0.9331, 0.2252, 0, 8.0383,
    4.4783, 1.6417, 1.0669, 0.7748, 0.4854, 15.2336, 18.5755,
    50.8925, 21.0845, 43.7285, 0.5146, 17.7664, 17.4245, 44.1075,
    23.9155, 42.2715, 2.348, 62.982, 88.7069, 168.5844, 101.819,
    246.5596, 2.652, 75.018, 82.2932, 201.4157, 129.181, 398.4402,
    8.937, 58.1727, 79.2047, 138.4458, 96.7556, 130.4843, 19.063,
    99.8273, 100.7953, 266.5541, 199.2444, 445.5158, 11.3075,
    54.4179, 51.1325, 96.9534, 46.4269, 39.7618, 32.6925, 100.582,
    83.8674, 210.0465, 121.5732, 194.2385, 9.6113, 34.5714, 21.8679,
    39.5798, 20.5459, 20.8238, 30.3887, 81.4286, 45.1321, 112.4202,
    68.4541, 131.1762, 2.3106, 3.661, 2.9909, 4.1855, 2.4351,
    2.417, 10.6894, 16.339, 10.0091, 19.8145, 11.5649, 20.5829,
    0, 29.7095, 15.6397, 7.8859, 5.9902, 0.7748, 0, 31.2904,
    16.3603, 2.1142, 3.0098, 1.2252, 0, 16.8236, 21.4326, 187.7156,
    98.2296, 99.7986, 0, 18.1764, 23.5674, 89.2844, 69.7704,
    63.2014, 1.314, 29.1265, 35.7795, 329.5423, 155.7406, 571.497,
    0.686, 34.8734, 42.2204, 234.4581, 134.2595, 656.5026, 12.5724,
    31.1426, 36.9686, 267.1615, 149.5154, 443.6395, 6.4276, 27.8574,
    31.0314, 158.8385, 108.4846, 558.3605, 10.0443, 40.5615,
    19.2137, 167.892, 70.4116, 166.8768, 5.9556, 33.4384, 17.7863,
    96.1075, 55.5883, 257.1239, 7.6909, 23.603, 11.1606, 75.5995,
    38.1762, 66.7699, 5.309, 26.397, 13.8394, 60.4003, 40.8238,
    141.2304, 3.3779, 1.0334, 0.8056, 8.2027, 2.9364, 9.6439,
    4.622, 2.9666, 2.1944, 14.7972, 6.0635, 37.3563, 18.1207,
    559.0214, 291.1981, 107.3569, 61.3029, 0, 16.8793, 464.9776,
    172.8023, 34.6437, 43.6971, 0, 17.2611, 314.732, 386.7151,
    658.4584, 357.958, 162.8754, 10.7389, 206.2679, 185.285,
    289.5417, 277.0419, 100.1246, 61.2104, 543.8367, 586.6229,
    924.4411, 350.6673, 332.2217, 34.7896, 312.1633, 238.377,
    480.5589, 260.3327, 292.7784, 142.5679, 512.2172, 395.5757,
    629.3403, 240.5213, 163.7777, 88.4322, 244.7827, 127.4239,
    304.6596, 167.4789, 176.2227, 199.4194, 421.6987, 243.4149,
    415.122, 102.8579, 50.4871, 158.5809, 205.3011, 95.5848,
    213.8778, 86.1423, 73.5132, 175.1989, 323.4688, 138.5463,
    229.4753, 59.6189, 30.6917, 156.8011, 206.5312, 70.4536,
    159.5246, 65.3811, 59.3083, 34.2207, 50.0278, 32.9282, 35.804,
    18.0735, 5.9458, 34.7793, 46.9722, 21.0719, 32.196, 21.9265,
    12.0542, 4.5123, 33.4184, 11.3414, 5.155, 2.5729, 0, 9.4878,
    140.5816, 54.6585, 27.845, 14.4271, 0, 13.9495, 62.6838,
    31.5314, 27.8692, 12.3005, 5.6655, 31.0506, 329.3163, 194.4686,
    325.1306, 118.6994, 23.3345, 82.4125, 165.0693, 65.7364,
    75.2081, 26.685, 17.8887, 117.5877, 532.9308, 241.2636, 727.7916,
    173.3149, 74.1113, 166.5621, 138.7004, 44.7576, 60.8825,
    16.9721, 13.1253, 253.4381, 364.2997, 127.2424, 536.1173,
    101.0278, 64.8747, 190.4805, 91.4837, 16.8599, 39.5424, 5.3798,
    4.2538, 401.5194, 264.5163, 63.1401, 400.4578, 41.6203, 30.7462,
    105.7405, 41.1254, 7.7165, 14.6369, 1.8479, 0.9329, 310.2585,
    192.8746, 46.2836, 247.364, 23.1522, 11.0672, 6.3391, 2.5212,
    1.0576, 0.7062, 0.242, 0.1338, 23.6608, 19.4788, 8.9424,
    17.2939, 3.758, 1.8662, 0.3152, 27.6177, 9.3034, 2.5235,
    2.2402, 0, 0.6848, 139.3823, 41.6966, 8.4766, 9.7598, 0,
    6.7784, 32.8381, 25.5897, 17.404, 19.5787, 10.8111, 8.2216,
    109.1619, 77.4103, 66.596, 77.4212, 22.1889, 22.794, 72.6106,
    30.8838, 40.8374, 17.4065, 21.4677, 18.2061, 152.3895, 57.1162,
    133.1626, 47.5935, 45.5323, 51.3243, 49.6369, 18.1114, 23.4676,
    10.5535, 8.9064, 48.6757, 94.3631, 28.8886, 77.5325, 29.4465,
    25.0936, 60.0942, 27.2953, 8.0423, 14.2918, 1.4422, 4.8342,
    83.9057, 60.7047, 17.9577, 57.7082, 5.5578, 21.1658, 43.1752,
    19.9206, 3.8195, 9.1317, 1.5232, 2.4297, 74.8245, 64.0794,
    12.1805, 54.8684, 8.4769, 15.5703, 4.5168, 1.0823, 0.2503,
    0.3439, 0.2559, 0.5507, 15.4831, 8.9177, 1.7497, 4.6561,
    2.7441, 6.4493, 53.0488, 996.2745, 140.9957, 32.7203, 19.9607,
    0, 59.9513, 1054.7261, 138.004, 19.2793, 20.0392, 0, 30.5267,
    150.6828, 68.1554, 105.6645, 107.8494, 56.1213, 17.4733,
    95.3172, 40.8446, 64.3355, 89.1507, 33.8787, 130.928, 356.3512,
    230.2683, 278.397, 114.6836, 156.3719, 22.0721, 63.6488,
    37.7317, 64.603, 29.3164, 43.628, 223.0532, 290.1089, 138.3794,
    271.7068, 109.6827, 114.069, 37.9469, 39.8915, 16.6208, 54.293,
    24.3172, 35.9306, 387.6757, 290.5258, 119.3347, 175.1978,
    54.4808, 48.7852, 90.3241, 43.4749, 18.6656, 39.8021, 15.519,
    22.2144, 651.5847, 526.3114, 176.8909, 258.5742, 81.2881,
    67.3507, 229.4153, 138.6894, 48.1093, 106.4255, 40.7117,
    54.6487, 1346.2051, 932.7097, 361.9745, 474.7484, 151.0569,
    110.3054, 777.7956, 522.291, 179.026, 365.2509, 120.9428,
    135.6938),
    dim = c(6,2,7,6),
    dimnames = list(
        hlosp = c("Less than grade 9", "Grades 9-13", "High school",
                  "Trades and non-uni", "University w/o degree", "University"),
        sexp = c("Female", "Male"),
        agep = c("15-19", "20-24", "25-34", "35-44", "45-54", "55-64", "65+"),
        occ81p = c("Manage/admin", "Sci/teach/art", "Clerical/sales/service",
                   "Proc/Mach fab/Construct/Transp", "Other/Relig/Farm/Primary",
                   "NA"))
)
assert(abs(result - eresult) < 0.05)
assert(unlist(dimnames(eresult)) == unlist(dimnames(result)))


#
# Slightly trickier test: mix of two-way and one-way constraintList.
#
cat('\nTest: One 2-way and two 1-way constraints\n')
result <- ipf(constraintList =
                 lapply(list(margin.table(testtab, c(1,2)),
                             margin.table(testtab, c(3)),
                             margin.table(testtab, c(4))),
                        IpfConstraint),
              dimnameList = dimnames(testtab),
              maxIterations = 20,
              tolerance = 1/100)
eresult <- array(
    data = c(38.0553, 65.8445, 35.3383, 57.2954, 24.4262, 28.6123,
    28.7804, 59.2247, 25.2581, 56.8705, 25.5944, 38.3208, 49.244,
    85.2036, 45.7282, 74.1409, 31.6078, 37.0246, 37.2422, 76.6374,
    32.6843, 73.5912, 33.1195, 49.5876, 96.735, 167.3741, 89.8286,
    145.6424, 62.0904, 72.7312, 73.1587, 150.5467, 64.205, 144.5626,
    65.0599, 97.4099, 79.0983, 136.8585, 73.4511, 119.089, 50.7701,
    59.4709, 59.8204, 123.0991, 52.4992, 118.206, 53.1982, 79.6502,
    56.9267, 98.4964, 52.8624, 85.7078, 36.539, 42.8009, 43.0525,
    88.5938, 37.7834, 85.0723, 38.2865, 57.3239, 49.5031, 85.6519,
    45.9688, 74.531, 31.7741, 37.2195, 37.4382, 77.0407, 32.8563,
    73.9784, 33.2937, 49.8485, 46.9346, 81.2078, 43.5837, 70.6639,
    30.1255, 35.2883, 35.4957, 73.0434, 31.1515, 70.14, 31.5663,
    47.2621, 46.0575, 79.6902, 42.7692, 69.3433, 29.5625, 34.6288,
    34.8323, 71.6783, 30.5693, 68.8292, 30.9763, 46.3788, 59.5989,
    103.12, 55.3438, 89.731, 38.2542, 44.8101, 45.0734, 92.7525,
    39.557, 89.0657, 40.0837, 60.0147, 117.0762, 202.5691, 108.7175,
    176.2678, 75.1466, 88.025, 88.5423, 182.2033, 77.7059, 174.9609,
    78.7406, 117.893, 95.7309, 165.6368, 88.8962, 144.1307, 61.4459,
    71.9763, 72.3993, 148.9841, 63.5386, 143.0621, 64.3846, 96.3988,
    68.8971, 119.208, 63.9782, 103.7302, 44.2223, 51.801, 52.1055,
    107.2232, 45.7285, 102.9611, 46.3373, 69.3778, 59.9125, 103.6626,
    55.6351, 90.2032, 38.4555, 45.0459, 45.3106, 93.2406, 39.7652,
    89.5344, 40.2947, 60.3305, 56.8039, 98.284, 52.7484, 85.5229,
    36.4602, 42.7086, 42.9596, 88.4028, 37.702, 84.8888, 38.2039,
    57.2002, 119.6013, 206.9381, 111.0624, 180.0696, 76.7674,
    89.9235, 90.452, 186.1331, 79.3819, 178.7345, 80.4389, 120.4358,
    154.7655, 267.7804, 143.716, 233.0121, 99.3379, 116.3621,
    117.0459, 240.8584, 102.7211, 231.2845, 104.0888, 155.8453,
    304.0217, 526.0282, 282.316, 457.7294, 195.1395, 228.5819,
    229.9252, 473.1426, 201.7856, 454.3357, 204.4723, 306.1428,
    248.5926, 430.123, 230.8442, 374.2764, 159.5618, 186.9069,
    188.0054, 386.8794, 164.9961, 371.5014, 167.193, 250.327,
    178.911, 309.5576, 166.1376, 269.365, 114.8359, 134.5161,
    135.3066, 278.4354, 118.747, 267.3679, 120.328, 180.1592,
    155.58, 269.1895, 144.4723, 234.2383, 99.8606, 116.9744,
    117.6619, 242.1258, 103.2617, 232.5016, 104.6366, 156.6654,
    147.5075, 255.2223, 136.9762, 222.0846, 94.6793, 110.9051,
    111.5569, 229.5629, 97.9038, 220.438, 99.2074, 148.5367,
    59.7252, 103.3385, 55.4611, 89.9211, 38.3352, 44.905, 45.1689,
    92.949, 39.6409, 89.2544, 40.1687, 60.1419, 77.2851, 133.7212,
    71.7673, 116.359, 49.6062, 58.1076, 58.4491, 120.2771, 51.2957,
    115.4963, 51.9787, 77.8243, 151.8189, 262.6821, 140.9798,
    228.5758, 97.4466, 114.1467, 114.8175, 236.2726, 100.7654,
    226.8811, 102.1071, 152.8781, 124.1394, 214.79, 115.2764,
    186.9019, 79.6802, 93.3355, 93.884, 193.1955, 82.3939, 185.5162,
    83.491, 125.0055, 89.3426, 154.5834, 82.9639, 134.5125, 57.3455,
    67.1731, 67.5679, 139.0419, 59.2985, 133.5152, 60.0881, 89.9659,
    77.6918, 134.4248, 72.1449, 116.9713, 49.8673, 58.4134, 58.7567,
    120.9101, 51.5657, 116.104, 52.2522, 78.2338, 73.6607, 127.4501,
    68.4016, 110.9021, 47.2799, 55.3825, 55.708, 114.6365, 48.8901,
    110.0799, 49.5411, 74.1746, 18.4201, 31.8711, 17.105, 27.733,
    11.8231, 13.8494, 13.9307, 28.6668, 12.2258, 27.5274, 12.3886,
    18.5486, 23.8358, 41.2416, 22.1341, 35.8868, 15.2993, 17.9212,
    18.0266, 37.0952, 15.8203, 35.6207, 16.031, 24.0021, 46.8232,
    81.015, 43.4802, 70.4961, 30.0539, 35.2045, 35.4114, 72.8699,
    31.0775, 69.9734, 31.4913, 47.1499, 38.2864, 66.2444, 35.5529,
    57.6433, 24.5745, 28.786, 28.9552, 59.5843, 25.4115, 57.2159,
    25.7498, 38.5535, 27.5545, 47.6758, 25.5873, 41.4856, 17.6862,
    20.7172, 20.8389, 42.8826, 18.2885, 41.178, 18.532, 27.7468,
    23.9613, 41.4586, 22.2506, 36.0757, 15.3798, 18.0155, 18.1214,
    37.2904, 15.9036, 35.8082, 16.1154, 24.1284, 22.718, 39.3075,
    21.0961, 34.2038, 14.5818, 17.0808, 17.1812, 35.3556, 15.0784,
    33.9502, 15.2792, 22.8765, 111.0312, 192.1098, 103.1041,
    167.1665, 71.2665, 83.48, 83.9706, 172.7955, 73.6937, 165.9271,
    74.6749, 111.8058, 143.6756, 248.5923, 133.4179, 216.3154,
    92.2197, 108.024, 108.6589, 223.5994, 95.3605, 214.7115,
    96.6302, 144.678, 282.2367, 488.3351, 262.0863, 424.9303,
    181.1566, 212.2026, 213.4497, 439.239, 187.3264, 421.7797,
    189.8206, 284.2058, 230.7794, 399.302, 214.3028, 347.4572,
    148.1282, 173.5139, 174.5336, 359.1571, 153.1731, 344.881,
    155.2126, 232.3895, 166.0909, 287.3759, 154.2328, 250.0634,
    106.6072, 124.8772, 125.6111, 258.4838, 110.238, 248.2093,
    111.7058, 167.2497, 144.4317, 249.9004, 134.1199, 217.4537,
    92.705, 108.5925, 109.2307, 224.776, 95.8623, 215.8414, 97.1387,
    145.4394, 136.9377, 236.9341, 127.161, 206.1709, 87.8949,
    102.958, 103.5631, 213.1133, 90.8884, 204.6423, 92.0986,
    137.8931),
    dim = c(6,2,7,6),
    dimnames = list(
        hlosp = c("Less than grade 9", "Grades 9-13", "High school",
                  "Trades and non-uni", "University w/o degree", "University"),
        sexp = c("Female", "Male"),
        agep = c("15-19", "20-24", "25-34", "35-44", "45-54", "55-64", "65+"),
        occ81p = c("Manage/admin", "Sci/teach/art", "Clerical/sales/service",
                   "Proc/Mach fab/Construct/Transp", "Other/Relig/Farm/Primary",
                   "NA"))
)
assert(eresult == round(result, 4))
assert(unlist(dimnames(eresult)) == unlist(dimnames(result)))

cat('\nTest: One 2-way, two 1-way constraintList and one 0-way constraint\n')
result <- ipf(constraintList =
                lapply(list(margin.table(testtab, c(1,2)),
                            margin.table(testtab, c(3)),
                            margin.table(testtab, c(4)),
                            sum(testtab)),
                       IpfConstraint),
              dimnameList = dimnames(testtab),
              maxIterations = 20,
              tolerance = 1/100)
assert(eresult == round(result, 4))
assert(unlist(dimnames(eresult)) == unlist(dimnames(result)))

cat('\nTest: Same, but with prior array\n')
result <- ipf(constraintList = 
                  lapply(list(margin.table(testtab, c(1,2)),
                              margin.table(testtab, c(3)),
                              margin.table(testtab, c(4)),
                              sum(testtab)),
                         IpfConstraint),
              dimnameList = dimnames(testtab),
              maxIterations = 20,
              tolerance = 1/100)
assert(eresult == round(result, 4))
assert(unlist(dimnames(eresult)) == unlist(dimnames(result)))

cat('\nTest: Same, but with -4 error allowed\n')
err4 <- function(con) {
    IpfConstraint(min = ifelse(con - 4 < 0, 0, con - 4), data = con, max = con)
}
result <- ipf(constraintList =
                 list(err4(margin.table(testtab, c(1,2))),
                             err4(margin.table(testtab, c(3))),
                             err4(margin.table(testtab, c(4))),
                             err4(sum(testtab))),
              dimnameList = dimnames(testtab),
              maxIterations = 20,
              tolerance = 1/100)
eresult <- array( data = c(
     38.0637, 65.8590, 35.3461, 57.3080, 24.4210, 28.6122, 28.7806, 59.2377,
     25.2539, 56.8831, 25.5906, 38.3292, 49.2548, 85.2223, 45.7383, 74.1572,
     31.6010, 37.0245, 37.2424, 76.6543, 32.6788, 73.6073, 33.1145, 49.5985,
     96.7365, 167.3767, 89.8300, 145.6447, 62.0644, 72.7162, 73.1441, 150.5490,
     64.1812, 144.5649, 65.0370, 97.4114, 79.0940, 136.8510, 73.4471, 119.0825,
     50.7452, 59.4544, 59.8043, 123.0923, 52.4760, 118.1995, 53.1757, 79.6458,
     56.9392, 98.5181, 52.8740, 85.7267, 36.5312, 42.8008, 43.0527, 88.6133,
     37.7771, 85.0911, 38.2808, 57.3365, 49.5140, 85.6708, 45.9790, 74.5474,
     31.7673, 37.2194, 37.4384, 77.0577, 32.8508, 73.9947, 33.2888, 49.8595,
     46.9449, 81.2257, 43.5933, 70.6794, 30.1190, 35.2882, 35.4958, 73.0594,
     31.1463, 70.1554, 31.5616, 47.2725, 46.0676, 79.7077, 42.7786, 69.3586,
     29.5561, 34.6287, 34.8325, 71.6941, 30.5642, 68.8443, 30.9717, 46.3890,
     59.6120, 103.1427, 55.3560, 89.7508, 38.2460, 44.8100, 45.0736, 92.7730,
     39.5505, 89.0853, 40.0778, 60.0279, 117.0781, 202.5723, 108.7192, 176.2705,
     75.1151, 88.0068, 88.5246, 182.2061, 77.6771, 174.9636, 78.7128, 117.8949,
     95.7257, 165.6277, 88.8913, 144.1228, 61.4158, 71.9564, 72.3798, 148.9759,
     63.5106, 143.0543, 64.3574, 96.3936, 68.9123, 119.2343, 63.9923, 103.7531,
     44.2128, 51.8009, 52.1057, 107.2468, 45.7208, 102.9838, 46.3304, 69.3931,
     59.9257, 103.6855, 55.6473, 90.2231, 38.4472, 45.0458, 45.3108, 93.2612,
     39.7586, 89.5541, 40.2887, 60.3438, 56.8164, 98.3056, 52.7600, 85.5418,
     36.4524, 42.7085, 42.9598, 88.4222, 37.6957, 84.9075, 38.1983, 57.2128,
     119.6071, 206.9482, 111.0677, 180.0783, 76.7377, 89.9079, 90.4369,
     186.1421, 79.3551, 178.7431, 80.4131, 120.4416, 154.7730, 267.7933,
     143.7230, 233.0234, 99.2995, 116.3418, 117.0264, 240.8700, 102.6864,
     231.2957, 104.0555, 155.8528, 303.9743, 525.9462, 282.2719, 457.6580,
     195.0243, 228.4954, 229.8399, 473.0688, 201.6760, 454.2648, 204.3650,
     306.0950, 248.5363, 430.0256, 230.7920, 374.1917, 159.4563, 186.8231,
     187.9224, 386.7919, 164.8950, 371.4173, 167.0936, 250.2703, 178.9196,
     309.5726, 166.1456, 269.3781, 114.7915, 134.4927, 135.2841, 278.4489,
     118.7068, 267.3808, 120.2895, 180.1679, 155.5875, 269.2025, 144.4793,
     234.2496, 99.8221, 116.9541, 117.6423, 242.1376, 103.2267, 232.5128,
     104.6031, 156.6730, 147.5147, 255.2347, 136.9828, 222.0953, 94.6427,
     110.8858, 111.5383, 229.5740, 97.8707, 220.4487, 99.1756, 148.5438,
     59.7383, 103.3612, 55.4733, 89.9409, 38.3270, 44.9049, 45.1691,
     92.9695, 39.6342, 89.2741, 40.1627, 60.1551, 77.3021, 133.7506,
     71.7831, 116.3846, 49.5956, 58.1075, 58.4494, 120.3036, 51.2872,
     115.5217, 51.9710, 77.8414, 151.8213, 262.6862, 140.9820, 228.5794,
     97.4058, 114.1231, 114.7946, 236.2763, 100.7280, 226.8846, 102.0710,
     152.8805, 124.1326, 214.7783, 115.2701, 186.8917, 79.6412, 93.3096,
     93.8587, 193.1850, 82.3575, 185.5061, 83.4556, 124.9986, 89.3622,
     154.6174, 82.9822, 134.5421, 57.3331, 67.1730, 67.5682, 139.0726,
     59.2886, 133.5446, 60.0791, 89.9857, 77.7089, 134.4544, 72.1608,
     116.9970, 49.8566, 58.4132, 58.7570, 120.9367, 51.5571, 116.1296,
     52.2445, 78.2510, 73.6769, 127.4781, 68.4167, 110.9265, 47.2697,
     55.3824, 55.7083, 114.6618, 48.8820, 110.1041, 49.5337, 74.1909,
     18.4242, 31.8781, 17.1088, 27.7391, 11.8206, 13.8493, 13.9308,
     28.6732, 12.2238, 27.5334, 12.3868, 18.5527, 23.8411, 41.2506,
     22.1389, 35.8947, 15.2960, 17.9212, 18.0266, 37.1034, 15.8177,
     35.6286, 16.0286, 24.0074, 46.8239, 81.0163, 43.4809, 70.4972,
     30.0414, 35.1972, 35.4043, 72.8711, 31.0660, 69.9745, 31.4802,
     47.1506, 38.2843, 66.2407, 35.5510, 57.6401, 24.5625, 28.7781,
     28.9474, 59.5811, 25.4003, 57.2128, 25.7389, 38.5514, 27.5606,
     47.6863, 25.5929, 41.4947, 17.6824, 20.7171, 20.8390, 42.8920,
     18.2855, 41.1871, 18.5293, 27.7529, 23.9666, 41.4677, 22.2555,
     36.0836, 15.3765, 18.0155, 18.1215, 37.2986, 15.9009, 35.8161,
     16.1130, 24.1338, 22.7230, 39.3161, 21.1007, 34.2114, 14.5787,
     17.0807, 17.1812, 35.3634, 15.0759, 33.9577, 15.2769, 22.8816,
     111.0345, 192.1155, 103.1071, 167.1715, 71.2377, 83.4639, 83.9550,
     172.8007, 73.6674, 165.9320, 74.6496, 111.8091, 143.6799, 248.5997,
     133.4218, 216.3218, 92.1824, 108.0032, 108.6387, 223.6061, 95.3265,
     214.7179, 96.5975, 144.6823, 282.1874, 488.2498, 262.0405, 424.8561,
     181.0462, 212.1184, 213.3665, 439.1623, 187.2212, 421.7061, 189.7175,
     284.1561, 230.7229, 399.2043, 214.2503, 347.3721, 148.0275, 173.4328,
     174.4534, 359.0692, 153.0764, 344.7966, 155.1174, 232.3326, 166.0959,
     287.3845, 154.2374, 250.0708, 106.5640, 124.8531, 125.5878, 258.4915,
     110.1986, 248.2167, 111.6680, 167.2547, 144.4360, 249.9079, 134.1240,
     217.4602, 92.6675, 108.5716, 109.2104, 224.7827, 95.8281, 215.8479,
     97.1058, 145.4437, 136.9418, 236.9412, 127.1648, 206.1770, 87.8593,
     102.9382, 103.5439, 213.1197, 90.8560, 204.6484, 92.0674, 137.8972),
    dim = c(6,2,7,6),
    dimnames = list(
        hlosp = c("Less than grade 9", "Grades 9-13", "High school",
                  "Trades and non-uni", "University w/o degree", "University"),
        sexp = c("Female", "Male"),
        agep = c("15-19", "20-24", "25-34", "35-44", "45-54", "55-64", "65+"),
        occ81p = c("Manage/admin", "Sci/teach/art", "Clerical/sales/service",
                   "Proc/Mach fab/Construct/Transp", "Other/Relig/Farm/Primary",
                   "NA"))
)
assert(eresult == round(result, 4))
assert(unlist(dimnames(eresult)) == unlist(dimnames(result)))

# Execute function to execute this code.
})()

